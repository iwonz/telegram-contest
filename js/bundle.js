'use strict';(function(p){"function"===typeof define&&define.amd?define(p):p()})(function(){function p(d,a){if(!(d instanceof a))throw new TypeError("Cannot call a class as a function");}function A(d,a){for(var b=0;b<a.length;b++){var c=a[b];c.enumerable=c.enumerable||!1;c.configurable=!0;"value"in c&&(c.writable=!0);Object.defineProperty(d,c.key,c)}}function u(d,a,b){a&&A(d.prototype,a);b&&A(d,b);return d}function E(d,a,b){a in d?Object.defineProperty(d,a,{value:b,enumerable:!0,configurable:!0,writable:!0}):
d[a]=b;return d}function r(d,a){var b=[0],c=[];Object.keys(d).forEach(function(e){e=d[e];var g=a?e.columns.slice(a.start,a.end):e.columns;e=Math.min.apply(Math,g);g=Math.max.apply(Math,g);b.push(e);c.push(g)});var e=Math.min.apply(Math,b),g=Math.max.apply(Math,c);return{min:e,max:g}}function q(d,a,b){a.split(" ").forEach(function(a){d.addEventListener(a,b)})}function B(d,a,b){a.split(" ").forEach(function(a){d.removeEventListener(a,b)})}function v(d,a){function b(){c?(e=arguments,g=this):(d.apply(this,
arguments),c=!0,setTimeout(function(){c=!1;e&&(b.apply(g,e),e=g=null)},a))}var c=!1,e,g;return b}function C(d,a){var b=null;return function(){var c=this,e=[].slice.call(arguments);b&&clearTimeout(b);b=setTimeout(function(){d.apply(c,e);b=null},a)}}function w(d,a){var b=null,c=v(function(c){null!==b&&!1!==a(b.pageX-c.pageX)&&(b=c)},t),e=v(function(){B(document,"mousemove touchmove",c);B(document,"mouseup touchend",e);b=null},t);q(d,"mousedown touchstart",function(a){a.stopImmediatePropagation();b=
a;q(document,"mousemove touchmove",c);q(document,"mouseup touchend",e)})}function D(d){var a=d.canvas,b=d.ctx;return function(){var c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=c.graph,d=c.range,f=c.marginBottom,h=c.lineWidth;c=(a.height-(c.marginTop+f))/c.graphsValuesRange.max;d=d?e.columns.slice(d.start,d.end):e.columns;var k=x(a.width,d);f=a.height-f;var l=0;b.lineWidth=h||1;b.lineCap="round";b.strokeStyle=e.lineColor;b.beginPath();b.moveTo(l,.5+(f-d[0]*c)<<0);for(e=1;e<d.length;e++)b.lineTo(l+
k,.5+(f-d[e]*c)<<0),l+=k;b.stroke()}}function x(d,a,b){return d/(b?Math.abs(b.end-b.start)-1:a.length-1)}var t=1E3/60,F=function(){function d(a,b){p(this,d);this.chart=a;this.config=b;this.range={};this.initElements();this.addEventListeners();this.draw();this.updateRange()}u(d,[{key:"initElements",value:function(){var a=document.querySelector(this.chart.selector);this.canvas=a.querySelector(".tl-canvas");this.updateCanvasSize();this.ctx=this.canvas.getContext("2d");this.controller=a.querySelector(".tl__ctrl");
this.shadowLeft=a.querySelector(".tl__shadow_lt");this.shadowRight=a.querySelector(".tl__shadow_rt");this.resizeLeft=a.querySelector(".tl__ctrl-resize_lt");this.resizeRight=a.querySelector(".tl__ctrl-resize_rt")}},{key:"draw",value:function(){var a=this;requestAnimationFrame(function(){return a.drawGraphs()});requestAnimationFrame(function(){return a.updateShadows()})}},{key:"updateCanvasSize",value:function(){this.canvas.width=this.canvas.parentNode.offsetWidth;this.canvas.height=Math.max(.15*window.innerHeight,
70)}},{key:"onRangeChanged",value:function(){this.updateShadows();this.updateRange();this.config.onRangeChange(this.range)}},{key:"addEventListeners",value:function(){var a=this;w(this.controller,function(b){var c=a.canvas.width-a.controller.offsetWidth;b=parseInt(getComputedStyle(a.controller).right,10)+b;0>=b&&(b=0);b>=c&&(b=c);a.controller.style.right=b+"px";a.onRangeChanged()});w(this.resizeLeft,function(b){b=a.controller.offsetWidth+b;if(parseInt(getComputedStyle(a.controller).right,10)+b>a.canvas.width||
b<=.25*a.canvas.width)return!1;a.controller.style.width=b+"px";a.onRangeChanged()});w(this.resizeRight,function(b){var c=parseInt(getComputedStyle(a.controller).right,10);b=a.controller.offsetWidth-b;c+=a.controller.offsetWidth-b;if(0>c||b<=.25*a.canvas.width)return!1;a.controller.style.right=c+"px";a.controller.style.width=b+"px";a.onRangeChanged()})}},{key:"updateShadows",value:function(){var a=parseInt(getComputedStyle(this.controller).right,10);this.shadowLeft.style.width=this.canvas.width-a-
this.controller.offsetWidth+"px";this.shadowRight.style.width=a+"px"}},{key:"updateRange",value:function(){var a=parseInt(getComputedStyle(this.controller).right,10),b=this.controller.offsetWidth,c=this.canvas.width/this.chart.model.x.columns.length;a=Math.floor((this.canvas.width-a-b)/c);this.range={start:a,end:a+Math.ceil(b/c)}}},{key:"drawGraphs",value:function(){var a=D(this);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var b=this.chart.getGraphs(!0),c=r(b);Object.keys(b).forEach(function(e){a({graph:b[e],
marginTop:4,marginBottom:4,graphsValuesRange:c,lineWidth:2})})}},{key:"onViewportResize",value:function(){this.updateCanvasSize();this.controller.style.right="0px";this.draw()}}]);return d}(),G=function(){function d(a){p(this,d);this.chart=a;this.initElements();this.addEventListeners()}u(d,[{key:"initElements",value:function(){this.canvas=document.createElement("canvas");this.updateCanvasStyles();this.ctx=this.canvas.getContext("2d");this.chart.canvas.insertAdjacentElement("afterend",this.canvas);
this.balloon=document.createElement("div");this.balloon.classList.add("balloon");this.balloon.id="balloon"+this.chart.uniqueId;this.balloon.innerHTML='\n      <div class="balloon__header"></div>\n      <div class="balloon__content"></div>\n    ';document.body.appendChild(this.balloon)}},{key:"getIndexByCoords",value:function(a){var b=this.chart.timeline.range,c=x(this.chart.canvas.width,null,b);a=.5+a/c<<0;return{global:b.start+a,inRange:a}}},{key:"addEventListeners",value:function(){var a=this,b=
v(function(b){b.stopImmediatePropagation();a.updateBalloon(b.layerX,b.layerY);a.drawLine(b.layerX,b.layerY);a.drawDots(b.layerX,b.layerY)},t),c=C(function(b){b.stopImmediatePropagation();a.balloon.style.display="none";a.clearCanvas()},t);q(this.canvas,"mousemove touchmove",b);q(this.canvas,"mouseenter touchstart",function(b){b.stopImmediatePropagation();a.balloon.style.display="flex"});q(this.canvas,"mouseleave touchend",c)}},{key:"drawDots",value:function(a,b){var c=this,e=this.getIndexByCoords(a);
a=this.chart.timeline.range;b=this.chart.getGraphs(!0);var d=r(b,a),f=(this.chart.canvas.height-y)/d.max,h=x(this.chart.canvas.width,null,a);Object.keys(b).forEach(function(a){var b=e.inRange*h,d=.5+(c.canvas.height-m-c.chart.model[a].columns[e.global]*f)<<0;c.ctx.fillStyle=document.body.classList.contains("_night")?"#242f3e":"#fff";c.ctx.strokeStyle=c.chart.model[a].lineColor;c.ctx.lineWidth=3;c.ctx.beginPath();c.ctx.arc(b,d,5,0,2*Math.PI);c.ctx.fill();c.ctx.stroke()})}},{key:"updateBalloon",value:function(a){var b=
this,c=this.canvas.getBoundingClientRect(),e=this.balloon.getBoundingClientRect(),d=c.left+a,f=d-e.width/2;this.balloon.style.left=a<=c.left+e.width?(.5+d<<0)+"px":a>=c.width-e.width?(.5+(d-e.width)<<0)+"px":(.5+f<<0)+"px";this.balloon.style.top=c.top-10+"px";var h=this.getIndexByCoords(a).global,k=null,l=[];Object.keys(this.chart.model).forEach(function(a){b.chart.model[a].visible&&("x"===a?k=b.chart.model[a].columns[h]:l.push({name:b.chart.model[a].name,lineColor:b.chart.model[a].lineColor,value:b.chart.model[a].columns[h]}))});
a=(new Date(k)).toLocaleDateString(navigator.language||navigator.userLanguage,{weekday:"short",month:"short",day:"numeric"});var n=this.balloon.querySelector(".balloon__content");this.balloon.querySelector(".balloon__header").innerHTML=a;n.innerHTML="";l.forEach(function(a){var b=document.createElement("div");b.classList.add("balloon__item");b.innerHTML="\n        <b>".concat(a.value.toLocaleString(),"</b>\n        <b>").concat(a.name,"</b>\n      ");b.style.color=a.lineColor;n.appendChild(b)})}},
{key:"clearCanvas",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"drawLine",value:function(a){this.clearCanvas();this.ctx.lineWidth=1;this.ctx.strokeStyle="rgba(221, 234, 243, 0.7)";this.ctx.beginPath();this.ctx.moveTo(a,this.canvas.height-m);this.ctx.lineTo(a,z);this.ctx.stroke()}},{key:"updateCanvasStyles",value:function(){var a=getComputedStyle(this.chart.canvas);this.canvas.width=this.chart.canvas.width;this.canvas.height=this.chart.canvas.height;this.canvas.style.position=
"absolute";this.canvas.style.left="0px";this.canvas.style.top="0px";this.canvas.style.zIndex=parseInt(a.zIndex,10)+1}},{key:"onViewportResize",value:function(){this.updateCanvasStyles();this.clearCanvas()}},{key:"onColorModeChange",value:function(){this.balloon.classList.toggle("balloon_night")}}]);return d}(),z=20,m=30,y=z+m,H=0,I=function(){function d(a){var b=this;p(this,d);E(this,"onViewportResize",C(function(){b.updateCanvasSize();b.draw();b.timeline.onViewportResize();b.balloon.onViewportResize()},
100));this.uniqueId=++H;this.selector="#chart-"+this.uniqueId;this.config=a;this.model=this.getModel(this.config.data);this.drawTemplate();requestAnimationFrame(function(){b.initElements();b.draw()})}u(d,[{key:"drawTemplate",value:function(){var a=document.createElement("div");a.classList.add("chart");a.id=this.selector.slice(1);a.innerHTML=document.querySelector(".chart-template").innerHTML;document.querySelector(this.config.appendTo||"body").appendChild(a)}},{key:"initElements",value:function(){var a=
this;this.wrapper=document.querySelector(this.selector);this.canvas=this.wrapper.querySelector(".chart-canvas");this.updateCanvasSize();this.ctx=this.canvas.getContext("2d");this.balloon=new G(this);this.timeline=new F(this,{onRangeChange:function(){a.draw()}});this.drawSwitches()}},{key:"drawSwitches",value:function(){var a=this,b=this.wrapper.querySelector(".chart__switches");Object.keys(this.getGraphs()).forEach(function(c){var d=document.createElement("label");d.classList.add("check");d.innerHTML=
'\n        <input class="check__input" type="checkbox" value="'.concat(c,'" checked>\n        <span class="check__box" style="border-color: ').concat(a.model[c].lineColor,"; background-color: ").concat(a.model[c].lineColor,';"></span>\n        <span class="check__value">').concat(a.model[c].name,"</span>\n      ");b.appendChild(d);d.querySelector(".check__input").addEventListener("change",function(b){a.toggleGraphVisible(b.target.value,b.target.checked);a.updateDisabledSwitches()})});this.updateDisabledSwitches()}},
{key:"updateDisabledSwitches",value:function(){var a=this.wrapper.querySelectorAll(".check .check__input:checked");if(1===a.length)return a[0].disabled=!0;[].slice.call(a).forEach(function(a){return a.disabled=!1})}},{key:"updateCanvasSize",value:function(){this.canvas.width=this.canvas.parentNode.offsetWidth;this.canvas.height=Math.max(.4*window.innerHeight,180)}},{key:"getModel",value:function(a){return a.columns.reduce(function(b,c){b[c[0]]={columns:c.slice(1),type:a.types[c[0]],name:a.names[c[0]],
lineColor:a.colors[c[0]],visible:!0};return b},{})}},{key:"draw",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.drawYLines();this.drawGraphs();this.drawXValues();this.drawYValues()}},{key:"getGraphs",value:function(a){var b=this;return Object.keys(this.model).reduce(function(c,d){if(a&&!b.model[d].visible)return c;"x"!==d&&(c[d]=b.model[d]);return c},{})}},{key:"getDates",value:function(a){return a?this.model.x.columns.slice(a.start,a.end):this.model.x.columns}},
{key:"drawGraphs",value:function(){var a=this,b=D(this),c=this.getGraphs(!0);Object.keys(c).forEach(function(d){b({graph:c[d],range:a.timeline.range,marginTop:z,marginBottom:m,graphsValuesRange:r(c,a.timeline.range),lineWidth:3})})}},{key:"drawYLines",value:function(){var a=300>this.canvas.height?3:6,b=(this.canvas.height-y)/(a-1);this.ctx.lineWidth=1;this.ctx.strokeStyle=document.body.classList.contains("_night")?"rgba(242, 244, 245, 0.1)":"rgba(242, 244, 245, 0.7)";for(var c,d=0;d<a;d++)c=.5+(this.canvas.height-
b*d-m)<<0,this.ctx.beginPath(),this.ctx.moveTo(0,c),this.ctx.lineTo(this.canvas.width,c),this.ctx.stroke()}},{key:"drawYValues",value:function(){for(var a=300>this.canvas.height?3:6,b=r(this.getGraphs(!0),this.timeline.range),c,d=b.min,g=(this.canvas.height-y)/(a-1),f=(b.max-b.min)/(a-1),h=0;h<a;h++){c=.5+(this.canvas.height-g*h-m)<<0;var k=this.ctx,l=(.5+d<<0).toLocaleString();c-=5;var n=void 0;n=n||"Arial, Tahoma";k.font="".concat(16,"px ").concat(n);k.fillStyle="#96a2aa";k.fillText(l,5,c);d=d>=
b.max?b.max:d+f}}},{key:"drawXValues",value:function(){for(var a=420>this.canvas.width?3:6,b=this.getDates(this.timeline.range),c=.5+b.length/a<<0,d=0,g=this.canvas.width/a-1,f=15,h=this.canvas.height-10,k=0;k<a;k++){var l=(new Date(b[d])).toLocaleDateString(navigator.language||navigator.userLanguage,{month:"short",day:"numeric"}),n=this.ctx,p=f,q=h,m=void 0;m=m||"Arial, Tahoma";n.font="".concat(16,"px ").concat(m);n.fillStyle="#96a2aa";n.fillText(l,p,q);d+=c;f+=g+15}}},{key:"toggleGraphVisible",
value:function(a,b){var c=this;Object.keys(this.model).forEach(function(d){d===a&&(c.model[d].visible=b)},{});this.draw();this.timeline.draw()}},{key:"onColorModeChange",value:function(){this.wrapper.classList.toggle("chart_night");this.draw();this.balloon.onColorModeChange()}}]);return d}();window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;document.addEventListener("DOMContentLoaded",function(){var d=
[];charts.forEach(function(a,b){d.push(new I({data:a,appendTo:".charts__content"}))});window.toggleMode=function(){document.querySelector(".mode-btn").classList.toggle("mode-btn_night");document.body.classList.toggle("_night");d.forEach(function(a){return a.onColorModeChange()})};window.addEventListener("resize",function(){return d.forEach(function(a){return a.onViewportResize()})})})});
